<!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„ä¸ªäººç®¡ç† - å¢å¼ºç¦»çº¿ç‰ˆ</title>
    <meta charset="UTF-8">
    <!-- å†…è”æ ·å¼ï¼Œé¿å…å¤–éƒ¨ä¾èµ– -->
    <style>
        /* ä»style.csså¤åˆ¶çš„å…³é”®æ ·å¼ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-color: #4a90e2;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }

        /* æ·±è‰²ä¸»é¢˜ */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            border-right: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .note-editor {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #editor, #preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
        }

        #editor {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            resize: none;
            outline: none;
            transition: background-color 0.3s, color 0.3s;
        }

        .note-toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-input {
            font-size: 20px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            width: 200px;
            transition: background-color 0.3s, color 0.3s;
        }

        button {
            padding: 8px 16px;
            margin-left: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        button:hover {
            background-color: var(--bg-secondary);
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .note-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .note-item:hover {
            background-color: var(--bg-secondary);
        }

        .note-item.active {
            background-color: var(--accent-color);
            color: white;
        }

        .note-item .note-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .note-item .note-preview {
            font-size: 0.85em;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .import-export {
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é¢„è§ˆæ ·å¼ */
        #preview {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        #preview code {
            background-color: var(--bg-secondary);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        #preview pre {
            background-color: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        #preview blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 10px;
            margin-left: 0;
            color: var(--text-secondary);
        }

        #preview table {
            border-collapse: collapse;
            width: 100%;
        }

        #preview table th, #preview table td {
            border: 1px solid var(--border-color);
            padding: 8px;
        }

        #preview table th {
            background-color: var(--bg-secondary);
            text-align: left;
        }

        .sidebar-footer {
            padding: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        /* å¯¼å…¥çº¿ä¸Šç¬”è®°çª—å£ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* æ·»åŠ åŒæ­¥çŠ¶æ€æ ·å¼ */
        .sync-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px;
            background-color: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .sync-status {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        
        .sync-status.online {
            background-color: var(--success-color);
            color: white;
        }
        
        .sync-status.offline {
            background-color: var(--warning-color);
            color: white;
        }
        
        .sync-indicator {
            margin-left: 5px;
            font-size: 0.8em;
        }
        
        /* å¾®è°ƒå¯¼å…¥çª—å£æ ·å¼ */
        .modal-content {
            max-width: 450px;
        }
        
        .form-group input {
            padding: 10px;
        }
    </style>
</head>
<body>
    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div id="notification" class="notification"></div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- å¯¼å…¥çº¿ä¸Šç¬”è®°çª—å£ -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å¯¼å…¥çº¿ä¸Šç¬”è®°</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="supabaseUrl">Supabase URL:</label>
                    <input type="text" id="supabaseUrl" value="https://gptacdyjxmjzlmgwjmms.supabase.co">
                </div>
                <div class="form-group">
                    <label for="supabaseKey">Supabase Key:</label>
                    <input type="password" id="supabaseKey" placeholder="è¾“å…¥æ‚¨çš„Supabaseè®¿é—®å¯†é’¥">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()">å–æ¶ˆ</button>
                <button onclick="importOnlineNotes()">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <div id="app" class="app-container">
        <div class="sidebar">
            <div class="note-toolbar">
                <h2>æˆ‘çš„ç¬”è®°</h2>
                <button onclick="createNewNote()">æ–°å»º</button>
            </div>
            <div id="notesList" class="notes-list">
                <!-- ç¬”è®°åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="sidebar-footer">
                <div class="sync-info">
                    <span id="syncStatus" class="sync-status offline">ç¦»çº¿</span>
                    <button onclick="forceSync()" title="ä¸äº‘ç«¯åŒæ­¥æ•°æ®">åŒæ­¥</button>
                </div>
                <button onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span> åˆ‡æ¢ä¸»é¢˜
                </button>
                <button onclick="showImportModal()">å¯¼å…¥çº¿ä¸Šç¬”è®°</button>
                <button onclick="exportNotes()">å¯¼å‡ºç¬”è®°</button>
            </div>
        </div>
        <div class="main-content">
            <div class="note-editor">
                <div class="note-toolbar">
                    <input type="text" id="noteTitle" placeholder="ç¬”è®°æ ‡é¢˜" class="title-input">
                    <div class="toolbar-buttons">
                        <button onclick="togglePreview()">
                            <span id="previewButtonText">é¢„è§ˆ</span>
                        </button>
                        <button onclick="saveNote()">ä¿å­˜</button>
                    </div>
                </div>
                <div class="editor-container">
                    <textarea id="editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥Markdownå†…å®¹..."></textarea>
                    <div id="preview" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å†…è”marked.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- æ·»åŠ Supabaseå®¢æˆ·ç«¯åº“ï¼Œç”¨äºåœ¨çº¿åŒæ­¥ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <script>
        // çŠ¶æ€ç®¡ç†
        let notes = [];
        let currentNote = null;
        let isPreviewMode = false;
        let supabaseClient = null;
        let isOnline = navigator.onLine;
        let syncInProgress = false;
        let lastSyncTime = localStorage.getItem('lastSyncTime') || null;
        let pendingChanges = JSON.parse(localStorage.getItem('pendingChanges') || '[]');

        // åˆå§‹åŒ–
        function init() {
            // é¦–å…ˆå°è¯•ä»localStorageåŠ è½½ç¬”è®°ï¼ˆè¿™æ ·ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ä¿®æ”¹çš„ç‰ˆæœ¬ï¼‰
            const storedNotes = localStorage.getItem('offline_notes');
            
            if (storedNotes) {
                // å¦‚æœlocalStorageä¸­æœ‰æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒ
                notes = JSON.parse(storedNotes);
                console.log('ä»localStorageåŠ è½½ç¬”è®°:', notes.length);
            } else if (window.PRELOADED_NOTES && window.PRELOADED_NOTES.length > 0) {
                // åªæœ‰åœ¨localStorageæ²¡æœ‰æ•°æ®æ—¶ï¼Œæ‰ä½¿ç”¨é¢„åŠ è½½çš„æ•°æ®
                notes = window.PRELOADED_NOTES;
                console.log('ä½¿ç”¨é¢„åŠ è½½æ•°æ®:', notes.length, 'æ¡ç¬”è®°');
                localStorage.setItem('offline_notes', JSON.stringify(notes));
                
                // å°†æ‰€æœ‰é¢„åŠ è½½çš„ç¬”è®°æ ‡è®°ä¸ºå·²åŒæ­¥
                localStorage.removeItem('pendingChanges');
                pendingChanges = [];
                console.log('æ‰€æœ‰ç¬”è®°å·²æ ‡è®°ä¸ºåŒæ­¥çŠ¶æ€');
            }
            
            renderNotesList();
            setupEventListeners();
            loadLastEditedNote();
            updateThemeIcon();
            checkOnlineStatus();
            initSupabaseConnection();
        }

        // æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
        function checkOnlineStatus() {
            isOnline = navigator.onLine;
            updateSyncStatus();
            
            if (isOnline) {
                console.log('æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥ï¼Œåˆå§‹åŒ–åŒæ­¥æœåŠ¡');
                // å°è¯•åŒæ­¥
                if (!syncInProgress && pendingChanges.length > 0) {
                    console.log(`æœ‰ ${pendingChanges.length} æ¡ç¬”è®°ç­‰å¾…åŒæ­¥`);
                    syncWithSupabase();
                }
            } else {
                console.log('å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œå°†ä»…ä¿å­˜åˆ°æœ¬åœ°');
            }
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                syncStatus.className = isOnline ? 'sync-status online' : 'sync-status offline';
            }
        }

        // åˆå§‹åŒ–Supabaseè¿æ¥
        function initSupabaseConnection() {
            // è·å–å­˜å‚¨çš„Supabaseè¿æ¥ä¿¡æ¯
            const supabaseUrl = localStorage.getItem('supabaseUrl');
            const supabaseKey = localStorage.getItem('supabaseKey');
            
            if (supabaseUrl && supabaseKey && isOnline) {
                try {
                    console.log('æ­£åœ¨åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯...');
                    supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabaseå®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
                    
                    // æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ
                    testSupabaseConnection().then(valid => {
                        if (valid) {
                            console.log('Supabaseè¿æ¥æœ‰æ•ˆï¼');
                            showNotification('å·²è¿æ¥åˆ°äº‘ç«¯', 'success');
                            
                            // æœ‰å¾…åŒæ­¥çš„å†…å®¹æ—¶ï¼Œç«‹å³åŒæ­¥
                            if (pendingChanges.length > 0) {
                                console.log(`å¼€å§‹åŒæ­¥${pendingChanges.length}æ¡å¾…å¤„ç†ç¬”è®°...`);
                                syncWithSupabase();
                            }
                        } else {
                            console.error('Supabaseè¿æ¥æ— æ•ˆ');
                            supabaseClient = null;
                        }
                    });
                } catch (error) {
                    console.error('åˆå§‹åŒ–Supabaseå¤±è´¥:', error);
                    supabaseClient = null;
                }
            } else {
                if (!supabaseUrl || !supabaseKey) {
                    console.log('æœªæ‰¾åˆ°Supabaseè¿æ¥ä¿¡æ¯ï¼Œè¯·å…ˆå¯¼å…¥çº¿ä¸Šç¬”è®°');
                } else if (!isOnline) {
                    console.log('å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæš‚ä¸åˆå§‹åŒ–Supabase');
                }
            }
        }

        // æµ‹è¯•Supabaseè¿æ¥
        async function testSupabaseConnection() {
            if (!supabaseClient) return false;
            
            try {
                const { error } = await supabaseClient.from('notes').select('count');
                return !error;
            } catch (error) {
                console.error('æµ‹è¯•Supabaseè¿æ¥å¤±è´¥:', error);
                return false;
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è‡ªåŠ¨ä¿å­˜
            let autoSaveTimeout;
            document.getElementById('editor').addEventListener('input', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(saveNote, 1000);
            });

            // æ ‡é¢˜æ›´æ”¹
            document.getElementById('noteTitle').addEventListener('input', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(saveNote, 1000);
            });

            // æŒ‰é”®ç»‘å®š
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S ä¿å­˜
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveNote();
                }
                // Ctrl/Cmd + P é¢„è§ˆ
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    togglePreview();
                }
            });

            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', () => {
                isOnline = true;
                updateSyncStatus();
                showNotification('ç½‘ç»œå·²è¿æ¥', 'success');
                
                // ç½‘ç»œæ¢å¤æ—¶å°è¯•åŒæ­¥
                if (supabaseClient) {
                    syncWithSupabase();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus();
                showNotification('ç½‘ç»œå·²æ–­å¼€ï¼Œå°†ä¿å­˜åˆ°æœ¬åœ°', 'warning');
            });
        }

        // æ¸²æŸ“ç¬”è®°åˆ—è¡¨
        function renderNotesList() {
            const notesList = document.getElementById('notesList');
            notesList.innerHTML = '';
            
            if (notes.length === 0) {
                notesList.innerHTML = '<div class="note-item">æ²¡æœ‰ç¬”è®°</div>';
                return;
            }

            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item' + (currentNote && note.id === currentNote.id ? ' active' : '');
                
                const titleElement = document.createElement('div');
                titleElement.className = 'note-title';
                titleElement.textContent = note.title || 'æ— æ ‡é¢˜ç¬”è®°';
                
                const previewElement = document.createElement('div');
                previewElement.className = 'note-preview';
                previewElement.textContent = note.content ? note.content.substring(0, 50) : '';
                
                // æ·»åŠ åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨
                if (pendingChanges.includes(note.id)) {
                    const syncIndicator = document.createElement('span');
                    syncIndicator.className = 'sync-indicator';
                    syncIndicator.textContent = 'â±ï¸';
                    syncIndicator.title = 'ç­‰å¾…åŒæ­¥';
                    titleElement.appendChild(syncIndicator);
                }
                
                noteElement.appendChild(titleElement);
                noteElement.appendChild(previewElement);
                noteElement.onclick = () => loadNote(note);
                notesList.appendChild(noteElement);
            });
        }

        // åŠ è½½ç¬”è®°
        function loadNote(note) {
            currentNote = note;
            document.getElementById('noteTitle').value = note.title || '';
            document.getElementById('editor').value = note.content || '';
            renderNotesList();
            if (isPreviewMode) {
                updatePreview();
            }
        }

        // ä¿å­˜ç¬”è®°
        function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('editor').value;

            if (!title && !content) return; // ä¸ä¿å­˜ç©ºç¬”è®°

            if (!currentNote) {
                currentNote = {
                    id: Date.now(),
                    created_at: new Date().toISOString()
                };
                notes.unshift(currentNote);
            }

            currentNote.title = title;
            currentNote.content = content;
            currentNote.updated_at = new Date().toISOString();

            // æ·»åŠ åˆ°å¾…åŒæ­¥åˆ—è¡¨
            if (!pendingChanges.includes(currentNote.id)) {
                pendingChanges.push(currentNote.id);
                localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                console.log(`ç¬”è®° ID:${currentNote.id} å·²æ·»åŠ åˆ°å¾…åŒæ­¥åˆ—è¡¨`);
            }

            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('offline_notes', JSON.stringify(notes));
            console.log('ç¬”è®°å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            renderNotesList();
            showNotification('ç¬”è®°å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');

            // å¦‚æœåœ¨çº¿ï¼Œå°è¯•åŒæ­¥
            if (isOnline && supabaseClient) {
                console.log('æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥ï¼Œå°è¯•åŒæ­¥æ›´æ”¹');
                syncWithSupabase();
            } else {
                console.log('å½“å‰ç¦»çº¿ï¼Œæ›´æ”¹å°†åœ¨è”ç½‘åè‡ªåŠ¨åŒæ­¥');
            }
        }

        // ä¸SupabaseåŒæ­¥æ•°æ®
        async function syncWithSupabase() {
            if (!isOnline || !supabaseClient) {
                console.log('æ— æ³•åŒæ­¥ï¼š' + (!isOnline ? 'ç¦»çº¿çŠ¶æ€' : 'Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–'));
                return;
            }
            
            if (syncInProgress) {
                console.log('åŒæ­¥å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡');
                return;
            }
            
            if (pendingChanges.length === 0) {
                console.log('æ²¡æœ‰å¾…åŒæ­¥çš„ç¬”è®°');
                return;
            }

            try {
                syncInProgress = true;
                console.log('å¼€å§‹åŒæ­¥æ•°æ®...');
                showNotification('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');

                // è·å–å¾…åŒæ­¥çš„ç¬”è®°
                const notesToSync = notes.filter(note => pendingChanges.includes(note.id));
                console.log(`æ‰¾åˆ° ${notesToSync.length} æ¡å¾…åŒæ­¥ç¬”è®°`);
                
                for (const note of notesToSync) {
                    console.log(`åŒæ­¥ç¬”è®° ID:${note.id}, æ ‡é¢˜:${note.title}`);
                    
                    // æ£€æŸ¥æœåŠ¡å™¨ä¸Šæ˜¯å¦æœ‰è¿™ä¸ªç¬”è®°
                    const { data: existingNote, error: checkError } = await supabaseClient
                        .from('notes')
                        .select('id, updated_at')
                        .eq('id', note.id)
                        .maybeSingle();
                    
                    if (checkError) {
                        console.error('æ£€æŸ¥ç¬”è®°å­˜åœ¨æ€§å¤±è´¥:', checkError);
                        throw checkError;
                    }
                    
                    if (existingNote) {
                        console.log('ç¬”è®°å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°');
                        // ç¬”è®°å­˜åœ¨ï¼Œæ›´æ–°å®ƒ
                        const { error: updateError } = await supabaseClient
                            .from('notes')
                            .update({
                                title: note.title,
                                content: note.content,
                                updated_at: note.updated_at
                            })
                            .eq('id', note.id);
                        
                        if (updateError) {
                            console.error('æ›´æ–°ç¬”è®°å¤±è´¥:', updateError);
                            throw updateError;
                        }
                        
                        console.log('ç¬”è®°æ›´æ–°æˆåŠŸ');
                    } else {
                        console.log('ç¬”è®°ä¸å­˜åœ¨ï¼Œæ‰§è¡Œæ’å…¥');
                        // ç¬”è®°ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                        const { error: insertError } = await supabaseClient
                            .from('notes')
                            .insert([{
                                id: note.id,
                                title: note.title,
                                content: note.content,
                                created_at: note.created_at,
                                updated_at: note.updated_at
                            }]);
                        
                        if (insertError) {
                            console.error('æ’å…¥ç¬”è®°å¤±è´¥:', insertError);
                            throw insertError;
                        }
                        
                        console.log('ç¬”è®°æ’å…¥æˆåŠŸ');
                    }
                    
                    // ä»å¾…å¤„ç†åˆ—è¡¨ä¸­ç§»é™¤
                    const index = pendingChanges.indexOf(note.id);
                    if (index !== -1) {
                        pendingChanges.splice(index, 1);
                        console.log(`ç¬”è®° ID:${note.id} å·²ä»å¾…åŒæ­¥åˆ—è¡¨ç§»é™¤`);
                    }
                }
                
                // ä¿å­˜æ›´æ–°åçš„å¾…å¤„ç†åˆ—è¡¨
                localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                console.log('å¾…åŒæ­¥åˆ—è¡¨å·²æ›´æ–°:', pendingChanges);
                
                // æ‹‰å–æœåŠ¡å™¨ä¸Šçš„æœ€æ–°æ•°æ®
                await pullFromSupabase();
                
                // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
                lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastSyncTime', lastSyncTime);
                console.log('åŒæ­¥æ—¶é—´å·²æ›´æ–°:', lastSyncTime);
                
                showNotification('æ•°æ®åŒæ­¥å®Œæˆ', 'success');
                renderNotesList();
            } catch (error) {
                console.error('åŒæ­¥æ•°æ®å¤±è´¥:', error);
                showNotification('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                syncInProgress = false;
                console.log('åŒæ­¥è¿‡ç¨‹å·²å®Œæˆ');
            }
        }

        // ä»Supabaseæ‹‰å–æœ€æ–°æ•°æ®
        async function pullFromSupabase() {
            if (!supabaseClient) {
                console.log('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ‹‰å–æ•°æ®');
                return;
            }
            
            try {
                console.log('ä»Supabaseæ‹‰å–æœ€æ–°æ•°æ®...');
                let query = supabaseClient.from('notes').select('*').order('updated_at', { ascending: false });
                
                // å¦‚æœæœ‰ä¸Šæ¬¡åŒæ­¥æ—¶é—´ï¼Œåªè·å–æ›´æ–°çš„ç¬”è®°
                if (lastSyncTime) {
                    console.log('ä½¿ç”¨å¢é‡åŒæ­¥ï¼Œä¸Šæ¬¡åŒæ­¥æ—¶é—´:', lastSyncTime);
                    query = query.gt('updated_at', lastSyncTime);
                } else {
                    console.log('æ‰§è¡Œå…¨é‡åŒæ­¥');
                }
                
                const { data: serverNotes, error } = await query;
                
                if (error) {
                    console.error('ä»æœåŠ¡å™¨æ‹‰å–æ•°æ®å¤±è´¥:', error);
                    throw error;
                }
                
                console.log(`ä»æœåŠ¡å™¨è·å–äº† ${serverNotes ? serverNotes.length : 0} æ¡ç¬”è®°`);
                
                if (serverNotes && serverNotes.length > 0) {
                    // åˆ›å»ºIDæ˜ å°„ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾
                    const noteMap = {};
                    notes.forEach(note => {
                        noteMap[note.id] = note;
                    });
                    
                    // åˆ›å»ºå¾…åŒæ­¥ç¬”è®°çš„é›†åˆï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾
                    const pendingNotesSet = new Set(pendingChanges);
                    
                    console.log('åˆå¹¶æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°...');
                    
                    // åˆå¹¶æ–°ç¬”è®°æˆ–æ›´æ–°ç°æœ‰ç¬”è®°
                    serverNotes.forEach(serverNote => {
                        if (noteMap[serverNote.id]) {
                            // å¦‚æœæœ¬åœ°æ²¡æœ‰å¾…å¤„ç†çš„æ›´æ”¹ï¼Œåˆ™æ›´æ–°æœ¬åœ°ç¬”è®°
                            if (!pendingNotesSet.has(serverNote.id)) {
                                console.log(`æ›´æ–°ç¬”è®° ID:${serverNote.id}, æ ‡é¢˜:${serverNote.title}`);
                                noteMap[serverNote.id].title = serverNote.title;
                                noteMap[serverNote.id].content = serverNote.content;
                                noteMap[serverNote.id].updated_at = serverNote.updated_at;
                            } else {
                                console.log(`è·³è¿‡æ›´æ–°ç¬”è®° ID:${serverNote.id}ï¼Œå› ä¸ºæœ‰æœ¬åœ°ä¿®æ”¹`);
                            }
                        } else {
                            // æ·»åŠ æ–°ç¬”è®°
                            console.log(`æ·»åŠ æ–°ç¬”è®° ID:${serverNote.id}, æ ‡é¢˜:${serverNote.title}`);
                            notes.push(serverNote);
                        }
                    });
                    
                    // é‡æ–°æ’åºç¬”è®°
                    notes.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                    
                    // ä¿å­˜åˆ°æœ¬åœ°
                    localStorage.setItem('offline_notes', JSON.stringify(notes));
                    console.log('åˆå¹¶åçš„ç¬”è®°å·²ä¿å­˜åˆ°æœ¬åœ°');
                    
                    if (serverNotes.length > 0) {
                        showNotification(`å·²åŒæ­¥ ${serverNotes.length} æ¡ç¬”è®°`, 'success');
                    }
                } else {
                    console.log('æ²¡æœ‰æ–°çš„ç¬”è®°éœ€è¦åŒæ­¥');
                }
            } catch (error) {
                console.error('æ‹‰å–æœåŠ¡å™¨æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // åˆ‡æ¢é¢„è§ˆæ¨¡å¼
        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            const editor = document.getElementById('editor');
            const preview = document.getElementById('preview');
            const buttonText = document.getElementById('previewButtonText');
            
            if (isPreviewMode) {
                editor.style.display = 'none';
                preview.style.display = 'block';
                buttonText.textContent = 'ç¼–è¾‘';
                updatePreview();
            } else {
                editor.style.display = 'block';
                preview.style.display = 'none';
                buttonText.textContent = 'é¢„è§ˆ';
            }
        }

        // æ›´æ–°é¢„è§ˆå†…å®¹
        function updatePreview() {
            const content = document.getElementById('editor').value;
            document.getElementById('preview').innerHTML = marked.parse(content);
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeIcon();
        }

        // æ›´æ–°ä¸»é¢˜å›¾æ ‡
        function updateThemeIcon() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        // åŠ è½½ä¸Šæ¬¡ç¼–è¾‘çš„ç¬”è®°
        function loadLastEditedNote() {
            // åŠ è½½ä¸»é¢˜è®¾ç½®
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
            }

            if (notes.length > 0) {
                // æŒ‰æ›´æ–°æ—¶é—´æ’åº
                notes.sort((a, b) => {
                    return new Date(b.updated_at) - new Date(a.updated_at);
                });
                loadNote(notes[0]);
            }
        }

        // åˆ›å»ºæ–°ç¬”è®°
        function createNewNote() {
            currentNote = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('editor').value = '';
            document.getElementById('preview').innerHTML = '';
            saveNote();
        }

        // æ˜¾ç¤ºå¯¼å…¥çº¿ä¸Šç¬”è®°çª—å£
        function showImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        // å…³é—­æ¨¡æ€çª—å£
        function closeModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type + ' show';
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // å¯¼å…¥çº¿ä¸Šç¬”è®°
        async function importOnlineNotes() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            
            if (!supabaseUrl || !supabaseKey) {
                showNotification('è¯·è¾“å…¥Supabase URLå’Œå¯†é’¥', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // ä¿å­˜è¿æ¥ä¿¡æ¯
                localStorage.setItem('supabaseUrl', supabaseUrl);
                localStorage.setItem('supabaseKey', supabaseKey);
                
                // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                // æµ‹è¯•è¿æ¥
                const isValid = await testSupabaseConnection();
                if (!isValid) {
                    throw new Error('æ— æ³•è¿æ¥åˆ°Supabaseï¼Œè¯·æ£€æŸ¥æ‚¨çš„å‡­æ®');
                }
                
                // è·å–çº¿ä¸Šç¬”è®°
                const { data: onlineNotes, error } = await supabaseClient
                    .from('notes')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                if (onlineNotes.length === 0) {
                    showNotification('æ²¡æœ‰æ‰¾åˆ°çº¿ä¸Šç¬”è®°', 'warning');
                    closeModal();
                    hideLoading();
                    return;
                }
                
                // å°†çº¿ä¸Šç¬”è®°ä¸æœ¬åœ°ç¬”è®°åˆå¹¶
                const existingIds = new Set(notes.map(note => note.id));
                const pendingChangesSet = new Set(pendingChanges);
                
                onlineNotes.forEach(note => {
                    if (!existingIds.has(note.id)) {
                        // æ–°ç¬”è®°ç›´æ¥æ·»åŠ 
                        notes.push(note);
                        existingIds.add(note.id);
                    } else if (!pendingChangesSet.has(note.id)) {
                        // æ›´æ–°éæœ¬åœ°ä¿®æ”¹çš„ç¬”è®°
                        const localNote = notes.find(n => n.id === note.id);
                        const localUpdateTime = new Date(localNote.updated_at);
                        const serverUpdateTime = new Date(note.updated_at);
                        
                        if (serverUpdateTime > localUpdateTime) {
                            localNote.title = note.title;
                            localNote.content = note.content;
                            localNote.updated_at = note.updated_at;
                        }
                    }
                });
                
                // æŒ‰æ›´æ–°æ—¶é—´æ’åº
                notes.sort((a, b) => {
                    return new Date(b.updated_at) - new Date(a.updated_at);
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('offline_notes', JSON.stringify(notes));
                
                // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
                lastSyncTime = new Date().toISOString();
                localStorage.setItem('lastSyncTime', lastSyncTime);
                
                // æ›´æ–°UI
                renderNotesList();
                if (notes.length > 0) {
                    loadNote(notes[0]);
                }
                
                showNotification(`æˆåŠŸå¯¼å…¥ ${onlineNotes.length} æ¡ç¬”è®°`, 'success');
                closeModal();
            } catch (error) {
                console.error('å¯¼å…¥ç¬”è®°å¤±è´¥:', error);
                showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // å¯¼å‡ºç¬”è®°
        function exportNotes() {
            if (notes.length === 0) {
                showNotification('æ²¡æœ‰ç¬”è®°å¯å¯¼å‡º', 'warning');
                return;
            }
            
            try {
                // åˆ›å»ºä¸€ä¸ªåŒ…å«ç¬”è®°æ•°æ®çš„JSONæ–‡ä»¶
                const dataStr = JSON.stringify(notes, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const exportFileDefaultName = `ç¬”è®°å¤‡ä»½_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('ç¬”è®°å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºç¬”è®°å¤±è´¥:', error);
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¼ºåˆ¶åŒæ­¥
        async function forceSync() {
            if (!isOnline) {
                showNotification('å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•åŒæ­¥', 'warning');
                return;
            }
            
            if (!supabaseClient) {
                showNotification('æœªé…ç½®Supabaseè¿æ¥ï¼Œè¯·å…ˆå¯¼å…¥çº¿ä¸Šç¬”è®°', 'warning');
                showImportModal();
                return;
            }
            
            try {
                showLoading();
                await syncWithSupabase();
                showNotification('åŒæ­¥å®Œæˆ', 'success');
            } catch (error) {
                console.error('å¼ºåˆ¶åŒæ­¥å¤±è´¥:', error);
                showNotification('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html> 